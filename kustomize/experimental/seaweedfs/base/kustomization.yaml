apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- github.com/kubeflow/manifests/experimental/seaweedfs/istio?ref=v1.10.2
- netpol.yaml

patches:
  - target:
      group: networking.k8s.io
      version: v1
      kind: NetworkPolicy
      name: default-allow-same-namespace
      namespace: kubeflow
    patch: |-
      apiVersion: networking.k8s.io/v1
      kind: NetworkPolicy
      metadata:
        name: default-allow-same-namespace
        namespace: kubeflow
      $patch: delete
  - target:
      kind: Deployment
      name: ml-pipeline-ui
    patch: |
      - op: add
        path: /spec/template/spec/containers/0/command
        value: 
          - node
          - "--max-http-header-size=80000"
          - dist/server.js
          - ../client/
          - "3000"
  - target:
      kind: Deployment
      name: workflow-controller
    patch: |
      - op: add
        path: /spec/template/spec/priorityClassName
        value: business-value-medium

patchesStrategicMerge:
  # NOTE:
  #   Apply Auroraâ€™s updated AuthorizationPolicy for SeaweedFS.
  #   This replaces the upstream rule that only allows traffic from the
  #   Istio ingress gateway and instead permits calls originating from the
  #   kubeflow-service-account, which is the actual identity used for
  #   internal UI-to-UI mesh communication in secure Kubeflow deployments.
  #   Required for correct functionality under Istio AuthorizationPolicy
  #   enforcement and zero-trust mesh configurations.
  - patches/authorization-policy.yaml
  - patches/minio-deployment.yaml
  - patches/seaweedfs-deployment.yaml
  - patches/pvc-size.yaml
  - patches/virtual-service-metadata-grpc.yaml
  - patches/virtual-service-ml-pipeline-ui.yaml
  - patches/add-arg-metadata-grpc.yaml
  - patches/workflow-controller-configmap.yaml
