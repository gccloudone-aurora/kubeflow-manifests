apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- github.com/kubeflow/manifests/applications/kserve/models-web-app/overlays/kubeflow?ref=v1.10.2

# TODO:
#   Evaluate whether upstream resolves the large-JWT / cookie issue
#   caused by certain OIDC providers (e.g., Azure AD).
#   Some tokens exceed GRPC and gunicorn header limits used by
#   Kubeflow web applications.
#   Upstream guidance is documented here:
#     https://github.com/kubeflow/manifests/blob/v1.10.2/common/oauth2-proxy/README.md
#   If removing the `groups` claim in oauth2-proxy is insufficient,
#   add the required environment variable to all Kubeflow web apps
#   to support oversized provider tokens.
patches:
- path: patches/metadata-grpc-virtualservice.yaml
  target:
    kind: VirtualService
    name: metadata-grpc
    namespace: kubeflow
- path: patches/replace-virtual-service.yaml
  target:
    group: networking.istio.io
    kind: VirtualService
    name: kserve-models-web-app
    namespace: kserve
    version: v1beta1

patchesStrategicMerge:
  # NOTE:
  #   Apply Auroraâ€™s updated AuthorizationPolicy for the KServe.
  #   This replaces the upstream rule that only allows traffic from the
  #   Istio ingress gateway and instead permits calls originating from the
  #   kubeflow-service-account, which is the actual identity used for
  #   internal UI-to-UI mesh communication in secure Kubeflow deployments.
  #   Required for correct functionality under Istio AuthorizationPolicy
  #   enforcement and zero-trust mesh configurations.
  - patches/authorization-policy.yaml

# TODO:
#   Evaluate whether upstream resolves the large-JWT / cookie issue
#   caused by certain OIDC providers (e.g., Azure AD).
#   Some tokens exceed GRPC and gunicorn header limits used by
#   Kubeflow web applications.
#   Upstream guidance is documented here:
#     https://github.com/kubeflow/manifests/blob/v1.10.2/common/oauth2-proxy/README.md
#   If removing the `groups` claim in oauth2-proxy is insufficient,
#   add the required environment variable to all Kubeflow web apps
#   to support oversized provider tokens.
  - patches/deployment.yaml
